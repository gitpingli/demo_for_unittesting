'use strict';var cov_235763lxib=function(){var path="/home/htchen/console-core-service-sherpa/app/service/sonata/quote.js";var hash="eff3d3a2364c823fcac3905736cd5a4407e106fe";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/htchen/console-core-service-sherpa/app/service/sonata/quote.js",statementMap:{"0":{start:{line:3,column:26},end:{line:3,column:52}},"1":{start:{line:5,column:15},end:{line:9,column:1}},"2":{start:{line:13,column:4},end:{line:67,column:5}},"3":{start:{line:26,column:8},end:{line:65,column:9}},"4":{start:{line:54,column:12},end:{line:63,column:13}},"5":{start:{line:71,column:4},end:{line:71,column:57}},"6":{start:{line:73,column:22},end:{line:73,column:45}},"7":{start:{line:74,column:4},end:{line:76,column:5}},"8":{start:{line:75,column:6},end:{line:75,column:39}},"9":{start:{line:78,column:4},end:{line:80,column:5}},"10":{start:{line:79,column:13},end:{line:79,column:66}},"11":{start:{line:82,column:4},end:{line:82,column:31}},"12":{start:{line:85,column:16},end:{line:90,column:6}},"13":{start:{line:91,column:4},end:{line:95,column:5}},"14":{start:{line:92,column:6},end:{line:94,column:7}},"15":{start:{line:93,column:29},end:{line:93,column:65}},"16":{start:{line:97,column:4},end:{line:97,column:47}},"17":{start:{line:101,column:4},end:{line:101,column:48}},"18":{start:{line:103,column:16},end:{line:108,column:6}},"19":{start:{line:109,column:4},end:{line:109,column:47}},"20":{start:{line:113,column:4},end:{line:113,column:61}},"21":{start:{line:114,column:22},end:{line:114,column:45}},"22":{start:{line:115,column:4},end:{line:117,column:5}},"23":{start:{line:116,column:6},end:{line:116,column:39}},"24":{start:{line:119,column:19},end:{line:133,column:5}},"25":{start:{line:125,column:8},end:{line:131,column:9}},"26":{start:{line:134,column:4},end:{line:134,column:64}},"27":{start:{line:137,column:16},end:{line:142,column:6}},"28":{start:{line:143,column:4},end:{line:143,column:47}},"29":{start:{line:147,column:0},end:{line:147,column:29}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:12,column:2},end:{line:12,column:3}},loc:{start:{line:12,column:41},end:{line:68,column:3}},line:12},"1":{name:"(anonymous_1)",decl:{start:{line:25,column:37},end:{line:25,column:38}},loc:{start:{line:25,column:45},end:{line:66,column:7}},line:25},"2":{name:"(anonymous_2)",decl:{start:{line:53,column:42},end:{line:53,column:43}},loc:{start:{line:53,column:47},end:{line:64,column:11}},line:53},"3":{name:"(anonymous_3)",decl:{start:{line:70,column:2},end:{line:70,column:3}},loc:{start:{line:70,column:21},end:{line:98,column:3}},line:70},"4":{name:"(anonymous_4)",decl:{start:{line:79,column:6},end:{line:79,column:7}},loc:{start:{line:79,column:13},end:{line:79,column:66}},line:79},"5":{name:"(anonymous_5)",decl:{start:{line:93,column:16},end:{line:93,column:17}},loc:{start:{line:93,column:29},end:{line:93,column:65}},line:93},"6":{name:"(anonymous_6)",decl:{start:{line:100,column:2},end:{line:100,column:3}},loc:{start:{line:100,column:18},end:{line:110,column:3}},line:100},"7":{name:"(anonymous_7)",decl:{start:{line:112,column:2},end:{line:112,column:3}},loc:{start:{line:112,column:25},end:{line:144,column:3}},line:112},"8":{name:"(anonymous_8)",decl:{start:{line:124,column:35},end:{line:124,column:36}},loc:{start:{line:124,column:43},end:{line:132,column:7}},line:124}},branchMap:{"0":{loc:{start:{line:74,column:4},end:{line:76,column:5}},type:"if",locations:[{start:{line:74,column:4},end:{line:76,column:5}},{start:{line:74,column:4},end:{line:76,column:5}}],line:74},"1":{loc:{start:{line:79,column:13},end:{line:79,column:66}},type:"binary-expr",locations:[{start:{line:79,column:13},end:{line:79,column:45}},{start:{line:79,column:49},end:{line:79,column:66}}],line:79},"2":{loc:{start:{line:91,column:4},end:{line:95,column:5}},type:"if",locations:[{start:{line:91,column:4},end:{line:95,column:5}},{start:{line:91,column:4},end:{line:95,column:5}}],line:91},"3":{loc:{start:{line:115,column:4},end:{line:117,column:5}},type:"if",locations:[{start:{line:115,column:4},end:{line:117,column:5}},{start:{line:115,column:4},end:{line:117,column:5}}],line:115},"4":{loc:{start:{line:121,column:18},end:{line:121,column:44}},type:"binary-expr",locations:[{start:{line:121,column:18},end:{line:121,column:36}},{start:{line:121,column:40},end:{line:121,column:44}}],line:121},"5":{loc:{start:{line:122,column:17},end:{line:122,column:42}},type:"binary-expr",locations:[{start:{line:122,column:17},end:{line:122,column:34}},{start:{line:122,column:38},end:{line:122,column:42}}],line:122},"6":{loc:{start:{line:126,column:22},end:{line:126,column:37}},type:"binary-expr",locations:[{start:{line:126,column:22},end:{line:126,column:29}},{start:{line:126,column:33},end:{line:126,column:37}}],line:126},"7":{loc:{start:{line:127,column:21},end:{line:127,column:46}},type:"binary-expr",locations:[{start:{line:127,column:21},end:{line:127,column:38}},{start:{line:127,column:42},end:{line:127,column:46}}],line:127}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"eff3d3a2364c823fcac3905736cd5a4407e106fe"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const SonataBaseService=(cov_235763lxib.s[0]++,require('./sonataBackEnd'));const Q2SMAP=(cov_235763lxib.s[1]++,{PRC:'RECURRING',OTC:'NON_RECURRING',UBC:'NON_RECURRING'});class QuoteService extends SonataBaseService{async quoteSonataConverter(cpqResObj){cov_235763lxib.f[0]++;cov_235763lxib.s[2]++;return{id:cpqResObj.id,externalId:cpqResObj.externalId,state:cpqResObj.items[0].state,// first one in item
quoteDate:cpqResObj.createdAt,quoteLevel:'FIRM',instantSyncQuoting:true,effectiveQuoteCompletionDate:cpqResObj.createdAt,// validFor: {
//   startDate: '2020-05-29T02:52:09.246Z',
//   endDate: '2020-05-29T02:52:09.246Z',
// },
quoteItem:cpqResObj.items.map(item=>{cov_235763lxib.f[1]++;cov_235763lxib.s[3]++;return{id:item.id,state:item.state,externalId:item.externalId,productOffering:{id:item.offeringId},product:{// no id
productSpecification:{describing:item.specs}},validFor:{startDate:item.validFor.start,endDate:item.validFor.end},preCalculatedPrice:{priceType:Q2SMAP[item.price.type],// recurringChargePeriod: 'DAY',
price:{preTaxAmount:{value:item.price.amount,unit:item.price.currency}}},quoteItemPrice:item.prices.map(p=>{cov_235763lxib.f[2]++;cov_235763lxib.s[4]++;return{priceType:Q2SMAP[p.type],recurringChargePeriod:p.period,price:{preTaxAmount:{value:p.amount,unit:p.currency}}};})};})};}async list(query){cov_235763lxib.f[3]++;cov_235763lxib.s[5]++;this.ctx.logger.info('Quote list payload: %j',query);const companyId=(cov_235763lxib.s[6]++,this.ctx.user.companyId);cov_235763lxib.s[7]++;if(!companyId){cov_235763lxib.b[0][0]++;cov_235763lxib.s[8]++;this.ctx.throw(400,'No company');}else{cov_235763lxib.b[0][1]++;}// trim undefined
cov_235763lxib.s[9]++;Object.keys(query).forEach(key=>{cov_235763lxib.f[4]++;cov_235763lxib.s[10]++;return(cov_235763lxib.b[1][0]++,[undefined].includes(query[key]))&&(cov_235763lxib.b[1][1]++,delete query[key]);});// add companyId in the query
cov_235763lxib.s[11]++;query.companyId=companyId;// sonata converter
const res=(cov_235763lxib.s[12]++,await this.curl({service:'cpq',method:'GET',endpoint:'/quotes',payload:query}));cov_235763lxib.s[13]++;if(Array.isArray(res)){cov_235763lxib.b[2][0]++;cov_235763lxib.s[14]++;return await Promise.all(res.map(async obj=>{cov_235763lxib.f[5]++;cov_235763lxib.s[15]++;return await this.quoteSonataConverter(obj);}));}else{cov_235763lxib.b[2][1]++;}// return res
cov_235763lxib.s[16]++;return await this.quoteSonataConverter(res);}async show(id){cov_235763lxib.f[6]++;cov_235763lxib.s[17]++;this.ctx.logger.info('Quote detail: %j',id);// sonata converter
const res=(cov_235763lxib.s[18]++,await this.curl({service:'cpq',method:'GET',endpoint:`/quotes/${id}`// payload: query,
}));cov_235763lxib.s[19]++;return await this.quoteSonataConverter(res);}async create(payload){cov_235763lxib.f[7]++;cov_235763lxib.s[20]++;this.ctx.logger.info('Quote create payload: %j',payload);const companyId=(cov_235763lxib.s[21]++,this.ctx.user.companyId);cov_235763lxib.s[22]++;if(!companyId){cov_235763lxib.b[3][0]++;cov_235763lxib.s[23]++;this.ctx.throw(400,'No company');}else{cov_235763lxib.b[3][1]++;}const cpqReq=(cov_235763lxib.s[24]++,{companyId,externalId:(cov_235763lxib.b[4][0]++,payload.externalId)||(cov_235763lxib.b[4][1]++,null),projectId:(cov_235763lxib.b[5][0]++,payload.projectId)||(cov_235763lxib.b[5][1]++,null),// name: payload.name || null,
items:payload.quoteItem.map(item=>{cov_235763lxib.f[8]++;cov_235763lxib.s[25]++;return{externalId:(cov_235763lxib.b[6][0]++,item.id)||(cov_235763lxib.b[6][1]++,null),projectId:(cov_235763lxib.b[7][0]++,payload.projectId)||(cov_235763lxib.b[7][1]++,null),offeringId:item.productOffering.id,action:item.action,specs:item.product.productSpecification.describing};})});cov_235763lxib.s[26]++;this.ctx.logger.info('Quote CPQ create payload: %j',cpqReq);// sonata converter
const res=(cov_235763lxib.s[27]++,await this.curl({service:'cpq',method:'POST',endpoint:'/quotes',payload:cpqReq}));cov_235763lxib.s[28]++;return await this.quoteSonataConverter(res);}}cov_235763lxib.s[29]++;module.exports=QuoteService;