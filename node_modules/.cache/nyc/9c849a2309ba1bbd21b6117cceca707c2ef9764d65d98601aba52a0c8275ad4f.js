'use strict';var cov_2ktkjoo2iv=function(){var path="/home/htchen/console-core-service-sherpa/app/service/sonata/productOrder.js";var hash="e1ee32549f7f78a8436b0c255c19d987c85dfc74";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/htchen/console-core-service-sherpa/app/service/sonata/productOrder.js",statementMap:{"0":{start:{line:3,column:26},end:{line:3,column:52}},"1":{start:{line:5,column:15},end:{line:9,column:1}},"2":{start:{line:11,column:15},end:{line:15,column:1}},"3":{start:{line:19,column:4},end:{line:89,column:5}},"4":{start:{line:43,column:8},end:{line:87,column:9}},"5":{start:{line:93,column:4},end:{line:93,column:64}},"6":{start:{line:95,column:22},end:{line:95,column:45}},"7":{start:{line:96,column:4},end:{line:98,column:5}},"8":{start:{line:97,column:6},end:{line:97,column:39}},"9":{start:{line:100,column:4},end:{line:102,column:5}},"10":{start:{line:101,column:13},end:{line:101,column:66}},"11":{start:{line:104,column:4},end:{line:104,column:31}},"12":{start:{line:107,column:16},end:{line:112,column:6}},"13":{start:{line:114,column:4},end:{line:114,column:43}},"14":{start:{line:116,column:4},end:{line:120,column:5}},"15":{start:{line:117,column:6},end:{line:119,column:7}},"16":{start:{line:118,column:34},end:{line:118,column:70}},"17":{start:{line:121,column:4},end:{line:121,column:52}},"18":{start:{line:125,column:4},end:{line:125,column:55}},"19":{start:{line:126,column:16},end:{line:131,column:6}},"20":{start:{line:133,column:4},end:{line:133,column:47}},"21":{start:{line:137,column:4},end:{line:137,column:68}},"22":{start:{line:138,column:22},end:{line:138,column:45}},"23":{start:{line:139,column:4},end:{line:141,column:5}},"24":{start:{line:140,column:6},end:{line:140,column:39}},"25":{start:{line:143,column:19},end:{line:168,column:5}},"26":{start:{line:153,column:8},end:{line:163,column:9}},"27":{start:{line:170,column:4},end:{line:170,column:71}},"28":{start:{line:172,column:16},end:{line:177,column:6}},"29":{start:{line:179,column:4},end:{line:179,column:47}},"30":{start:{line:183,column:0},end:{line:183,column:36}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:18,column:2},end:{line:18,column:3}},loc:{start:{line:18,column:41},end:{line:90,column:3}},line:18},"1":{name:"(anonymous_1)",decl:{start:{line:42,column:37},end:{line:42,column:38}},loc:{start:{line:42,column:45},end:{line:88,column:7}},line:42},"2":{name:"(anonymous_2)",decl:{start:{line:92,column:2},end:{line:92,column:3}},loc:{start:{line:92,column:21},end:{line:122,column:3}},line:92},"3":{name:"(anonymous_3)",decl:{start:{line:101,column:6},end:{line:101,column:7}},loc:{start:{line:101,column:13},end:{line:101,column:66}},line:101},"4":{name:"(anonymous_4)",decl:{start:{line:118,column:21},end:{line:118,column:22}},loc:{start:{line:118,column:34},end:{line:118,column:70}},line:118},"5":{name:"(anonymous_5)",decl:{start:{line:124,column:2},end:{line:124,column:3}},loc:{start:{line:124,column:18},end:{line:134,column:3}},line:124},"6":{name:"(anonymous_6)",decl:{start:{line:136,column:2},end:{line:136,column:3}},loc:{start:{line:136,column:25},end:{line:180,column:3}},line:136},"7":{name:"(anonymous_7)",decl:{start:{line:152,column:35},end:{line:152,column:36}},loc:{start:{line:152,column:43},end:{line:164,column:7}},line:152}},branchMap:{"0":{loc:{start:{line:96,column:4},end:{line:98,column:5}},type:"if",locations:[{start:{line:96,column:4},end:{line:98,column:5}},{start:{line:96,column:4},end:{line:98,column:5}}],line:96},"1":{loc:{start:{line:101,column:13},end:{line:101,column:66}},type:"binary-expr",locations:[{start:{line:101,column:13},end:{line:101,column:45}},{start:{line:101,column:49},end:{line:101,column:66}}],line:101},"2":{loc:{start:{line:116,column:4},end:{line:120,column:5}},type:"if",locations:[{start:{line:116,column:4},end:{line:120,column:5}},{start:{line:116,column:4},end:{line:120,column:5}}],line:116},"3":{loc:{start:{line:139,column:4},end:{line:141,column:5}},type:"if",locations:[{start:{line:139,column:4},end:{line:141,column:5}},{start:{line:139,column:4},end:{line:141,column:5}}],line:139},"4":{loc:{start:{line:147,column:18},end:{line:147,column:44}},type:"binary-expr",locations:[{start:{line:147,column:18},end:{line:147,column:36}},{start:{line:147,column:40},end:{line:147,column:44}}],line:147},"5":{loc:{start:{line:149,column:14},end:{line:151,column:15}},type:"cond-expr",locations:[{start:{line:150,column:10},end:{line:150,column:39}},{start:{line:151,column:10},end:{line:151,column:15}}],line:149},"6":{loc:{start:{line:154,column:22},end:{line:154,column:37}},type:"binary-expr",locations:[{start:{line:154,column:22},end:{line:154,column:29}},{start:{line:154,column:33},end:{line:154,column:37}}],line:154},"7":{loc:{start:{line:156,column:18},end:{line:156,column:100}},type:"cond-expr",locations:[{start:{line:156,column:73},end:{line:156,column:92}},{start:{line:156,column:95},end:{line:156,column:100}}],line:156},"8":{loc:{start:{line:160,column:29},end:{line:160,column:52}},type:"binary-expr",locations:[{start:{line:160,column:29},end:{line:160,column:44}},{start:{line:160,column:48},end:{line:160,column:52}}],line:160},"9":{loc:{start:{line:165,column:19},end:{line:165,column:48}},type:"binary-expr",locations:[{start:{line:165,column:19},end:{line:165,column:38}},{start:{line:165,column:42},end:{line:165,column:48}}],line:165},"10":{loc:{start:{line:166,column:19},end:{line:166,column:54}},type:"binary-expr",locations:[{start:{line:166,column:19},end:{line:166,column:38}},{start:{line:166,column:42},end:{line:166,column:54}}],line:166}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"e1ee32549f7f78a8436b0c255c19d987c85dfc74"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const SonataBaseService=(cov_2ktkjoo2iv.s[0]++,require('./sonataBackEnd'));const S2OMAP=(cov_2ktkjoo2iv.s[1]++,{INSTALL:'ADD',CHANGE:'UPDATE',DISCONNECT:'REMOVE'});const O2SMAP=(cov_2ktkjoo2iv.s[2]++,{ADD:'INSTALL',UPDATE:'CHANGE',REMOVE:'DISCONNECT'});class ProductOrderService extends SonataBaseService{async orderSonataConverter(omsResObj){cov_2ktkjoo2iv.f[0]++;cov_2ktkjoo2iv.s[3]++;return{id:omsResObj.id,deleted:omsResObj.deleted,createdBy:omsResObj.createdBy,updatedBy:omsResObj.updatedBy,deletedBy:omsResObj.deletedBy,cancelledBy:omsResObj.cancelledBy,orderDate:omsResObj.createdAt,updatedAt:omsResObj.updatedAt,deletedAt:omsResObj.deletedAt,cancelledAt:omsResObj.cancelledAt,externalId:omsResObj.externalId,projectId:omsResObj.projectId,name:omsResObj.name,description:omsResObj.description,companyId:omsResObj.companyId,orderActivity:O2SMAP[omsResObj.action],state:omsResObj.state,completedAt:omsResObj.completedAt,completedBy:omsResObj.completedBy,cancellationReason:omsResObj.cancellationReason,billingType:omsResObj.billingType,paymentType:omsResObj.paymentType,orderItem:omsResObj.items.map(item=>{cov_2ktkjoo2iv.f[1]++;cov_2ktkjoo2iv.s[4]++;return{id:item.id,deleted:item.deleted,createdBy:item.createdBy,updatedBy:item.updatedBy,deletedBy:item.deletedBy,cancelledBy:item.cancelledBy,orderDate:item.createdAt,updatedAt:item.updatedAt,deletedAt:item.deletedAt,cancelledAt:item.cancelledAt,externalId:item.externalId,action:O2SMAP[item.action],quote:{// no id
quoteItem:item.quoteId},productOffering:{id:item.offeringId},product:{id:item.productInstanceId,buyerProductId:item.buyerProductId,productSpecification:{// id: 'string',
describing:item.provisionSpecs}},// refOrderId: item.refOrderId,
// refOrderItemId: item.refOrderItemId,
state:item.state,orderItemPrice:[{// priceType: 'RECURRING',
// recurringChargePeriod: 'DAY',
// name: 'string',
price:{dutyFreeAmount:{value:item.totalAmount,unit:item.currency}}}]};})};}async list(query){cov_2ktkjoo2iv.f[2]++;cov_2ktkjoo2iv.s[5]++;this.ctx.logger.info('ProductOrder list payload: %j',query);const companyId=(cov_2ktkjoo2iv.s[6]++,this.ctx.user.companyId);cov_2ktkjoo2iv.s[7]++;if(!companyId){cov_2ktkjoo2iv.b[0][0]++;cov_2ktkjoo2iv.s[8]++;this.ctx.throw(400,'No company');}else{cov_2ktkjoo2iv.b[0][1]++;}// trim undefined
cov_2ktkjoo2iv.s[9]++;Object.keys(query).forEach(key=>{cov_2ktkjoo2iv.f[3]++;cov_2ktkjoo2iv.s[10]++;return(cov_2ktkjoo2iv.b[1][0]++,[undefined].includes(query[key]))&&(cov_2ktkjoo2iv.b[1][1]++,delete query[key]);});// add companyId in the query
cov_2ktkjoo2iv.s[11]++;query.companyId=companyId;// query.companyId = 'a27e031a-27c6-4378-8464-35be8d899502';
const res=(cov_2ktkjoo2iv.s[12]++,await this.curl({service:'oms',method:'GET',endpoint:'/orders/v1',payload:query}));// get total from payload
cov_2ktkjoo2iv.s[13]++;this.ctx.set('X-Total-Count',res.size);cov_2ktkjoo2iv.s[14]++;if(Array.isArray(res.data)){cov_2ktkjoo2iv.b[2][0]++;cov_2ktkjoo2iv.s[15]++;return await Promise.all(res.data.map(async obj=>{cov_2ktkjoo2iv.f[4]++;cov_2ktkjoo2iv.s[16]++;return await this.orderSonataConverter(obj);}));}else{cov_2ktkjoo2iv.b[2][1]++;}cov_2ktkjoo2iv.s[17]++;return await this.orderSonataConverter(res.data);}async show(id){cov_2ktkjoo2iv.f[5]++;cov_2ktkjoo2iv.s[18]++;this.ctx.logger.info('ProductOrder detail: %j',id);const res=(cov_2ktkjoo2iv.s[19]++,await this.curl({service:'oms',method:'GET',endpoint:`/orders/v1/${id}`// payload: query,
}));cov_2ktkjoo2iv.s[20]++;return await this.orderSonataConverter(res);}async create(payload){cov_2ktkjoo2iv.f[6]++;cov_2ktkjoo2iv.s[21]++;this.ctx.logger.info('ProductOrder create payload: %j',payload);const companyId=(cov_2ktkjoo2iv.s[22]++,this.ctx.user.companyId);cov_2ktkjoo2iv.s[23]++;if(!companyId){cov_2ktkjoo2iv.b[3][0]++;cov_2ktkjoo2iv.s[24]++;this.ctx.throw(400,'No company');}else{cov_2ktkjoo2iv.b[3][1]++;}const omsReq=(cov_2ktkjoo2iv.s[25]++,{name:payload.name,description:payload.description,companyId,externalId:(cov_2ktkjoo2iv.b[4][0]++,payload.externalId)||(cov_2ktkjoo2iv.b[4][1]++,null),projectId:payload.projectId,action:Object.prototype.hasOwnProperty.call(payload,'orderActivity')?(cov_2ktkjoo2iv.b[5][0]++,S2OMAP[payload.orderActivity]):(cov_2ktkjoo2iv.b[5][1]++,'ADD'),items:payload.orderItem.map(item=>{cov_2ktkjoo2iv.f[7]++;cov_2ktkjoo2iv.s[26]++;return{externalId:(cov_2ktkjoo2iv.b[6][0]++,item.id)||(cov_2ktkjoo2iv.b[6][1]++,null),buyerProductId:item.product.buyerProductId,action:Object.prototype.hasOwnProperty.call(item,'action')?(cov_2ktkjoo2iv.b[7][0]++,S2OMAP[item.action]):(cov_2ktkjoo2iv.b[7][1]++,'ADD'),quoteId:item.quote.quoteItem,offeringId:item.productOffering.id,provisionSpecs:item.product.productSpecification.describing,productInstanceId:(cov_2ktkjoo2iv.b[8][0]++,item.product.id)||(cov_2ktkjoo2iv.b[8][1]++,null)// refOrderId: item.refOrderId || null,
// refOrderItemId: item.refOrderItemId || null,
};}),billingType:(cov_2ktkjoo2iv.b[9][0]++,payload.billingType)||(cov_2ktkjoo2iv.b[9][1]++,'PAYG'),paymentType:(cov_2ktkjoo2iv.b[10][0]++,payload.paymentType)||(cov_2ktkjoo2iv.b[10][1]++,'CREDITCARD'),ready:true});cov_2ktkjoo2iv.s[27]++;this.ctx.logger.info('ProductOrder OMS create payload: %j',omsReq);const res=(cov_2ktkjoo2iv.s[28]++,await this.curl({service:'oms',method:'POST',endpoint:'/orders/v1',payload:omsReq}));// sonata converter for order
cov_2ktkjoo2iv.s[29]++;return await this.orderSonataConverter(res);}}cov_2ktkjoo2iv.s[30]++;module.exports=ProductOrderService;