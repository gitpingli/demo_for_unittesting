'use strict';var cov_2k5xnw6784=function(){var path="/home/pingli/workspace/repository/pccw/demo/sherpa-api/console-core-service-sherpa/app/service/consoleconnect/cc.js";var hash="2af8417718233175a065411dd755c1f5e7dfa7c8";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/pingli/workspace/repository/pccw/demo/sherpa-api/console-core-service-sherpa/app/service/consoleconnect/cc.js",statementMap:{"0":{start:{line:3,column:20},end:{line:3,column:34}},"1":{start:{line:7,column:20},end:{line:7,column:24}},"2":{start:{line:8,column:20},end:{line:8,column:68}},"3":{start:{line:9,column:27},end:{line:9,column:49}},"4":{start:{line:10,column:4},end:{line:14,column:5}},"5":{start:{line:11,column:34},end:{line:11,column:48}},"6":{start:{line:12,column:19},end:{line:12,column:54}},"7":{start:{line:13,column:6},end:{line:13,column:23}},"8":{start:{line:16,column:4},end:{line:16,column:70}},"9":{start:{line:20,column:20},end:{line:20,column:24}},"10":{start:{line:21,column:23},end:{line:21,column:27}},"11":{start:{line:23,column:36},end:{line:23,column:65}},"12":{start:{line:25,column:20},end:{line:25,column:43}},"13":{start:{line:26,column:16},end:{line:32,column:5}},"14":{start:{line:34,column:19},end:{line:34,column:47}},"15":{start:{line:38,column:4},end:{line:40,column:5}},"16":{start:{line:39,column:6},end:{line:39,column:24}},"17":{start:{line:42,column:4},end:{line:42,column:70}},"18":{start:{line:44,column:4},end:{line:44,column:41}},"19":{start:{line:48,column:20},end:{line:48,column:24}},"20":{start:{line:49,column:23},end:{line:49,column:27}},"21":{start:{line:51,column:45},end:{line:51,column:74}},"22":{start:{line:53,column:20},end:{line:53,column:39}},"23":{start:{line:54,column:16},end:{line:63,column:5}},"24":{start:{line:65,column:4},end:{line:65,column:72}},"25":{start:{line:67,column:19},end:{line:72,column:7}},"26":{start:{line:74,column:4},end:{line:76,column:5}},"27":{start:{line:75,column:6},end:{line:75,column:24}},"28":{start:{line:78,column:4},end:{line:78,column:67}},"29":{start:{line:80,column:4},end:{line:80,column:41}},"30":{start:{line:84,column:0},end:{line:84,column:38}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:6,column:2},end:{line:6,column:3}},loc:{start:{line:6,column:26},end:{line:17,column:3}},line:6},"1":{name:"(anonymous_1)",decl:{start:{line:19,column:2},end:{line:19,column:3}},loc:{start:{line:19,column:34},end:{line:45,column:3}},line:19},"2":{name:"(anonymous_2)",decl:{start:{line:47,column:2},end:{line:47,column:3}},loc:{start:{line:47,column:60},end:{line:81,column:3}},line:47}},branchMap:{"0":{loc:{start:{line:10,column:4},end:{line:14,column:5}},type:"if",locations:[{start:{line:10,column:4},end:{line:14,column:5}},{start:{line:10,column:4},end:{line:14,column:5}}],line:10},"1":{loc:{start:{line:10,column:8},end:{line:10,column:48}},type:"binary-expr",locations:[{start:{line:10,column:8},end:{line:10,column:22}},{start:{line:10,column:26},end:{line:10,column:48}}],line:10},"2":{loc:{start:{line:23,column:17},end:{line:23,column:31}},type:"default-arg",locations:[{start:{line:23,column:27},end:{line:23,column:31}}],line:23},"3":{loc:{start:{line:38,column:4},end:{line:40,column:5}},type:"if",locations:[{start:{line:38,column:4},end:{line:40,column:5}},{start:{line:38,column:4},end:{line:40,column:5}}],line:38},"4":{loc:{start:{line:38,column:8},end:{line:38,column:54}},type:"binary-expr",locations:[{start:{line:38,column:8},end:{line:38,column:29}},{start:{line:38,column:33},end:{line:38,column:54}}],line:38},"5":{loc:{start:{line:47,column:26},end:{line:47,column:40}},type:"default-arg",locations:[{start:{line:47,column:35},end:{line:47,column:40}}],line:47},"6":{loc:{start:{line:51,column:26},end:{line:51,column:40}},type:"default-arg",locations:[{start:{line:51,column:36},end:{line:51,column:40}}],line:51},"7":{loc:{start:{line:60,column:24},end:{line:60,column:51}},type:"binary-expr",locations:[{start:{line:60,column:24},end:{line:60,column:29}},{start:{line:60,column:33},end:{line:60,column:51}}],line:60},"8":{loc:{start:{line:67,column:19},end:{line:72,column:7}},type:"cond-expr",locations:[{start:{line:68,column:8},end:{line:68,column:36}},{start:{line:69,column:8},end:{line:72,column:7}}],line:67},"9":{loc:{start:{line:74,column:4},end:{line:76,column:5}},type:"if",locations:[{start:{line:74,column:4},end:{line:76,column:5}},{start:{line:74,column:4},end:{line:76,column:5}}],line:74},"10":{loc:{start:{line:74,column:8},end:{line:74,column:54}},type:"binary-expr",locations:[{start:{line:74,column:8},end:{line:74,column:29}},{start:{line:74,column:33},end:{line:74,column:54}}],line:74}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0},f:{"0":0,"1":0,"2":0},b:{"0":[0,0],"1":[0,0],"2":[0],"3":[0,0],"4":[0,0],"5":[0],"6":[0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"2af8417718233175a065411dd755c1f5e7dfa7c8"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const{Service}=(cov_2k5xnw6784.s[0]++,require('egg'));class ConsoleConnectService extends Service{async login(companyId){cov_2k5xnw6784.f[0]++;const{ctx}=(cov_2k5xnw6784.s[1]++,this);const company=(cov_2k5xnw6784.s[2]++,await ctx.service.ums.company.findOne(companyId));const consoleconnect=(cov_2k5xnw6784.s[3]++,company.consoleconnect);cov_2k5xnw6784.s[4]++;if((cov_2k5xnw6784.b[1][0]++,consoleconnect)&&(cov_2k5xnw6784.b[1][1]++,consoleconnect.enabled)){cov_2k5xnw6784.b[0][0]++;const{email,password}=(cov_2k5xnw6784.s[5]++,consoleconnect);const data=(cov_2k5xnw6784.s[6]++,await this.doLogin(email,password));cov_2k5xnw6784.s[7]++;return data.token;}else{cov_2k5xnw6784.b[0][1]++;}cov_2k5xnw6784.s[8]++;ctx.throw(403,'No permission to access ConsoleConnect resources');}async doLogin(email,password){cov_2k5xnw6784.f[1]++;const{ctx}=(cov_2k5xnw6784.s[9]++,this);const{config}=(cov_2k5xnw6784.s[10]++,this);const{url,timeout=(cov_2k5xnw6784.b[2][0]++,5000)}=(cov_2k5xnw6784.s[11]++,config.service.consoleconnect);const baseUrl=(cov_2k5xnw6784.s[12]++,`${url}/api/auth/token`);const req=(cov_2k5xnw6784.s[13]++,{method:'PUT',contentType:'json',dataType:'json',data:{email,password},timeout});const result=(cov_2k5xnw6784.s[14]++,await ctx.curl(baseUrl,req));// ctx.logger.info('result:%j', result);
cov_2k5xnw6784.s[15]++;if((cov_2k5xnw6784.b[4][0]++,result.status===200)||(cov_2k5xnw6784.b[4][1]++,result.status===201)){cov_2k5xnw6784.b[3][0]++;cov_2k5xnw6784.s[16]++;return result.data;}else{cov_2k5xnw6784.b[3][1]++;}cov_2k5xnw6784.s[17]++;ctx.logger.info('ConsoleConnectService doLogin result:%j',result);cov_2k5xnw6784.s[18]++;ctx.throw(result.status,result.data);}async curl({endpoint,method=(cov_2k5xnw6784.b[5][0]++,'GET'),payload,token}){cov_2k5xnw6784.f[2]++;const{ctx}=(cov_2k5xnw6784.s[19]++,this);const{config}=(cov_2k5xnw6784.s[20]++,this);const{url,enabled,timeout=(cov_2k5xnw6784.b[6][0]++,5000)}=(cov_2k5xnw6784.s[21]++,config.service.consoleconnect);const baseUrl=(cov_2k5xnw6784.s[22]++,`${url}${endpoint}`);const req=(cov_2k5xnw6784.s[23]++,{method,contentType:'json',dataType:'json',data:payload,headers:{'portal-token':(cov_2k5xnw6784.b[7][0]++,token)||(cov_2k5xnw6784.b[7][1]++,await this.login())},timeout});cov_2k5xnw6784.s[24]++;ctx.logger.info('ConsoleConnectService curl %s %s',method,baseUrl);const result=(cov_2k5xnw6784.s[25]++,enabled?(cov_2k5xnw6784.b[8][0]++,await ctx.curl(baseUrl,req)):(cov_2k5xnw6784.b[8][1]++,await require('../../../mockData/backendServiceManagement').curl(endpoint,req)));cov_2k5xnw6784.s[26]++;if((cov_2k5xnw6784.b[10][0]++,result.status===200)||(cov_2k5xnw6784.b[10][1]++,result.status===201)){cov_2k5xnw6784.b[9][0]++;cov_2k5xnw6784.s[27]++;return result.data;}else{cov_2k5xnw6784.b[9][1]++;}cov_2k5xnw6784.s[28]++;ctx.logger.info('ConsoleConnectService curl result:%j',result);cov_2k5xnw6784.s[29]++;ctx.throw(result.status,result.data);}}cov_2k5xnw6784.s[30]++;module.exports=ConsoleConnectService;