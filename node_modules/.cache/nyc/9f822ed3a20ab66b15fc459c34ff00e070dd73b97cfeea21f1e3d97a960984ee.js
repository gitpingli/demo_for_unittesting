'use strict';var cov_15fd1gt29v=function(){var path="/home/htchen/console-core-service-sherpa/app/service/sonata/productInventory.js";var hash="12d6678b8fb6c7d766c9f773b3bf32187e2c0640";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/htchen/console-core-service-sherpa/app/service/sonata/productInventory.js",statementMap:{"0":{start:{line:3,column:26},end:{line:3,column:52}},"1":{start:{line:5,column:16},end:{line:8,column:1}},"2":{start:{line:12,column:4},end:{line:59,column:6}},"3":{start:{line:63,column:4},end:{line:63,column:69}},"4":{start:{line:64,column:22},end:{line:64,column:45}},"5":{start:{line:65,column:4},end:{line:67,column:5}},"6":{start:{line:66,column:6},end:{line:66,column:40}},"7":{start:{line:69,column:4},end:{line:71,column:6}},"8":{start:{line:70,column:13},end:{line:70,column:68}},"9":{start:{line:73,column:4},end:{line:73,column:32}},"10":{start:{line:76,column:16},end:{line:81,column:6}},"11":{start:{line:83,column:4},end:{line:107,column:6}},"12":{start:{line:85,column:72},end:{line:85,column:73}},"13":{start:{line:86,column:8},end:{line:86,column:25}},"14":{start:{line:87,column:8},end:{line:104,column:9}},"15":{start:{line:93,column:10},end:{line:103,column:11}},"16":{start:{line:94,column:12},end:{line:97,column:14}},"17":{start:{line:98,column:17},end:{line:103,column:11}},"18":{start:{line:99,column:12},end:{line:102,column:14}},"19":{start:{line:105,column:8},end:{line:105,column:17}},"20":{start:{line:109,column:4},end:{line:109,column:44}},"21":{start:{line:111,column:4},end:{line:115,column:5}},"22":{start:{line:112,column:6},end:{line:114,column:8}},"23":{start:{line:113,column:34},end:{line:113,column:69}},"24":{start:{line:116,column:4},end:{line:116,column:52}},"25":{start:{line:120,column:4},end:{line:120,column:60}},"26":{start:{line:121,column:16},end:{line:126,column:6}},"27":{start:{line:129,column:68},end:{line:129,column:71}},"28":{start:{line:130,column:4},end:{line:130,column:23}},"29":{start:{line:131,column:4},end:{line:148,column:5}},"30":{start:{line:132,column:6},end:{line:144,column:7}},"31":{start:{line:133,column:8},end:{line:143,column:9}},"32":{start:{line:134,column:10},end:{line:137,column:12}},"33":{start:{line:138,column:15},end:{line:143,column:9}},"34":{start:{line:139,column:10},end:{line:142,column:12}},"35":{start:{line:146,column:6},end:{line:146,column:55}},"36":{start:{line:147,column:6},end:{line:147,column:77}},"37":{start:{line:149,column:4},end:{line:149,column:47}},"38":{start:{line:153,column:0},end:{line:153,column:41}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:11,column:2},end:{line:11,column:3}},loc:{start:{line:11,column:39},end:{line:60,column:3}},line:11},"1":{name:"(anonymous_1)",decl:{start:{line:62,column:2},end:{line:62,column:3}},loc:{start:{line:62,column:20},end:{line:117,column:3}},line:62},"2":{name:"(anonymous_2)",decl:{start:{line:70,column:6},end:{line:70,column:7}},loc:{start:{line:70,column:13},end:{line:70,column:68}},line:70},"3":{name:"(anonymous_3)",decl:{start:{line:84,column:19},end:{line:84,column:20}},loc:{start:{line:84,column:30},end:{line:106,column:7}},line:84},"4":{name:"(anonymous_4)",decl:{start:{line:113,column:21},end:{line:113,column:22}},loc:{start:{line:113,column:34},end:{line:113,column:69}},line:113},"5":{name:"(anonymous_5)",decl:{start:{line:119,column:2},end:{line:119,column:3}},loc:{start:{line:119,column:17},end:{line:150,column:3}},line:119}},branchMap:{"0":{loc:{start:{line:21,column:14},end:{line:23,column:18}},type:"cond-expr",locations:[{start:{line:22,column:14},end:{line:22,column:52}},{start:{line:23,column:14},end:{line:23,column:18}}],line:21},"1":{loc:{start:{line:24,column:16},end:{line:26,column:18}},type:"cond-expr",locations:[{start:{line:25,column:14},end:{line:25,column:44}},{start:{line:26,column:14},end:{line:26,column:18}}],line:24},"2":{loc:{start:{line:27,column:20},end:{line:29,column:18}},type:"cond-expr",locations:[{start:{line:28,column:14},end:{line:28,column:55}},{start:{line:29,column:14},end:{line:29,column:18}}],line:27},"3":{loc:{start:{line:65,column:4},end:{line:67,column:5}},type:"if",locations:[{start:{line:65,column:4},end:{line:67,column:5}},{start:{line:65,column:4},end:{line:67,column:5}}],line:65},"4":{loc:{start:{line:70,column:13},end:{line:70,column:68}},type:"binary-expr",locations:[{start:{line:70,column:13},end:{line:70,column:47}},{start:{line:70,column:51},end:{line:70,column:68}}],line:70},"5":{loc:{start:{line:87,column:8},end:{line:104,column:9}},type:"if",locations:[{start:{line:87,column:8},end:{line:104,column:9}},{start:{line:87,column:8},end:{line:104,column:9}}],line:87},"6":{loc:{start:{line:88,column:10},end:{line:91,column:34}},type:"binary-expr",locations:[{start:{line:88,column:10},end:{line:88,column:19}},{start:{line:89,column:10},end:{line:89,column:20}},{start:{line:90,column:10},end:{line:90,column:21}},{start:{line:91,column:10},end:{line:91,column:34}}],line:88},"7":{loc:{start:{line:93,column:10},end:{line:103,column:11}},type:"if",locations:[{start:{line:93,column:10},end:{line:103,column:11}},{start:{line:93,column:10},end:{line:103,column:11}}],line:93},"8":{loc:{start:{line:98,column:17},end:{line:103,column:11}},type:"if",locations:[{start:{line:98,column:17},end:{line:103,column:11}},{start:{line:98,column:17},end:{line:103,column:11}}],line:98},"9":{loc:{start:{line:111,column:4},end:{line:115,column:5}},type:"if",locations:[{start:{line:111,column:4},end:{line:115,column:5}},{start:{line:111,column:4},end:{line:115,column:5}}],line:111},"10":{loc:{start:{line:132,column:6},end:{line:144,column:7}},type:"if",locations:[{start:{line:132,column:6},end:{line:144,column:7}},{start:{line:132,column:6},end:{line:144,column:7}}],line:132},"11":{loc:{start:{line:132,column:10},end:{line:132,column:76}},type:"binary-expr",locations:[{start:{line:132,column:10},end:{line:132,column:19}},{start:{line:132,column:23},end:{line:132,column:33}},{start:{line:132,column:37},end:{line:132,column:48}},{start:{line:132,column:52},end:{line:132,column:76}}],line:132},"12":{loc:{start:{line:133,column:8},end:{line:143,column:9}},type:"if",locations:[{start:{line:133,column:8},end:{line:143,column:9}},{start:{line:133,column:8},end:{line:143,column:9}}],line:133},"13":{loc:{start:{line:138,column:15},end:{line:143,column:9}},type:"if",locations:[{start:{line:138,column:15},end:{line:143,column:9}},{start:{line:138,column:15},end:{line:143,column:9}}],line:138}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0,0,0],"7":[0,0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0,0,0],"12":[0,0],"13":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"12d6678b8fb6c7d766c9f773b3bf32187e2c0640"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const SonataBaseService=(cov_15fd1gt29v.s[0]++,require('./sonataBackEnd'));const SITEMAP=(cov_15fd1gt29v.s[1]++,{UNI:'UNI Site',NNI:'NNI Site'});class ProductInventoryService extends SonataBaseService{async inevSonataConverter(omsResObj){cov_15fd1gt29v.f[0]++;cov_15fd1gt29v.s[2]++;return{id:omsResObj.id,status:omsResObj.state,startDate:omsResObj.startAt,lastUpdateDate:omsResObj.updatedAt,terminationDate:omsResObj.endAt,// only one site for now
site:[{id:['UNI','NNI'].includes(omsResObj.productType)?(cov_15fd1gt29v.b[0][0]++,omsResObj.details.dataCenterFacilityId):(cov_15fd1gt29v.b[0][1]++,null),role:['UNI','NNI'].includes(omsResObj.productType)?(cov_15fd1gt29v.b[1][0]++,SITEMAP[omsResObj.productType]):(cov_15fd1gt29v.b[1][1]++,null),siteName:['UNI','NNI'].includes(omsResObj.productType)?(cov_15fd1gt29v.b[2][0]++,omsResObj.details.dataCenterFacility.name):(cov_15fd1gt29v.b[2][1]++,null),describing:omsResObj.details.dataCenterFacility}],productOffering:{id:omsResObj.offeringId},productSpecification:{// no productSpecification from oms product
id:null,describing:{...omsResObj.provisionSpecs,productCode:omsResObj.productCode,productType:omsResObj.productType,productProvider:omsResObj.productProvider,provisionProcessId:omsResObj.provisionProcessId,terminateProcessId:omsResObj.terminateProcessId,provisionProcessInstanceId:omsResObj.provisionProcessInstanceId,terminateProcessInstanceId:omsResObj.terminateProcessInstanceId,thirdPartyDetails:omsResObj.details}},productOrder:[{// fake data, no order
id:omsResObj.orderId,orderItemId:omsResObj.orderItemId}],buyerProductId:omsResObj.buyerProductId};}async list(query){cov_15fd1gt29v.f[1]++;cov_15fd1gt29v.s[3]++;this.ctx.logger.info('ProductInventory list payload: %j',query);const companyId=(cov_15fd1gt29v.s[4]++,this.ctx.user.companyId);cov_15fd1gt29v.s[5]++;if(!companyId){cov_15fd1gt29v.b[3][0]++;cov_15fd1gt29v.s[6]++;this.ctx.throw(400,'No company');}else{cov_15fd1gt29v.b[3][1]++;}// trim undefined
cov_15fd1gt29v.s[7]++;Object.keys(query).forEach(key=>{cov_15fd1gt29v.f[2]++;cov_15fd1gt29v.s[8]++;return(cov_15fd1gt29v.b[4][0]++,[undefined].includes(query[key]))&&(cov_15fd1gt29v.b[4][1]++,delete query[key]);});// add companyId in the query
cov_15fd1gt29v.s[9]++;query.companyId=companyId;// query.companyId = '72379d37-c66a-4c82-be56-9adcd4d02578';
const res=(cov_15fd1gt29v.s[10]++,await this.curl({service:'oms',method:'GET',endpoint:'/products/v1',payload:query}));cov_15fd1gt29v.s[11]++;await Promise.all(res.data.map(async p=>{cov_15fd1gt29v.f[3]++;const{companyId,resourceId,productProvider,productType}=(cov_15fd1gt29v.s[12]++,p);cov_15fd1gt29v.s[13]++;p.details=null;cov_15fd1gt29v.s[14]++;if((cov_15fd1gt29v.b[6][0]++,companyId)&&(cov_15fd1gt29v.b[6][1]++,resourceId)&&(cov_15fd1gt29v.b[6][2]++,productType)&&(cov_15fd1gt29v.b[6][3]++,productProvider==='CC')){cov_15fd1gt29v.b[5][0]++;cov_15fd1gt29v.s[15]++;if(productType==='ELINE'){cov_15fd1gt29v.b[7][0]++;cov_15fd1gt29v.s[16]++;p.details=await this.ctx.service.consoleconnect.connection.findOne(p.companyId,resourceId);}else{cov_15fd1gt29v.b[7][1]++;cov_15fd1gt29v.s[17]++;if(productType==='UNI'){cov_15fd1gt29v.b[8][0]++;cov_15fd1gt29v.s[18]++;p.details=await this.ctx.service.consoleconnect.port.findOne(p.companyId,resourceId);}else{cov_15fd1gt29v.b[8][1]++;}}}else{cov_15fd1gt29v.b[5][1]++;}cov_15fd1gt29v.s[19]++;return p;}));// get total from payload
cov_15fd1gt29v.s[20]++;this.ctx.set('X-Total-Count',res.size);cov_15fd1gt29v.s[21]++;if(Array.isArray(res.data)){cov_15fd1gt29v.b[9][0]++;cov_15fd1gt29v.s[22]++;return await Promise.all(res.data.map(async obj=>{cov_15fd1gt29v.f[4]++;cov_15fd1gt29v.s[23]++;return await this.inevSonataConverter(obj);}));}else{cov_15fd1gt29v.b[9][1]++;}cov_15fd1gt29v.s[24]++;return await this.inevSonataConverter(res.data);}async show(id){cov_15fd1gt29v.f[5]++;cov_15fd1gt29v.s[25]++;this.ctx.logger.info('ProductInventory detail: %j',id);const res=(cov_15fd1gt29v.s[26]++,await this.curl({service:'oms',method:'GET',endpoint:`/products/v1/${id}`// payload: query,
}));// res.companyId = '72379d37-c66a-4c82-be56-9adcd4d02578';
const{companyId,resourceId,productProvider,productType}=(cov_15fd1gt29v.s[27]++,res);cov_15fd1gt29v.s[28]++;res.details=null;cov_15fd1gt29v.s[29]++;try{cov_15fd1gt29v.s[30]++;if((cov_15fd1gt29v.b[11][0]++,companyId)&&(cov_15fd1gt29v.b[11][1]++,resourceId)&&(cov_15fd1gt29v.b[11][2]++,productType)&&(cov_15fd1gt29v.b[11][3]++,productProvider==='CC')){cov_15fd1gt29v.b[10][0]++;cov_15fd1gt29v.s[31]++;if(productType==='ELINE'){cov_15fd1gt29v.b[12][0]++;cov_15fd1gt29v.s[32]++;res.details=await this.ctx.service.consoleconnect.connection.findOne(res.companyId,resourceId);}else{cov_15fd1gt29v.b[12][1]++;cov_15fd1gt29v.s[33]++;if(productType==='UNI'){cov_15fd1gt29v.b[13][0]++;cov_15fd1gt29v.s[34]++;res.details=await this.ctx.service.consoleconnect.port.findOne(res.companyId,resourceId);}else{cov_15fd1gt29v.b[13][1]++;}}}else{cov_15fd1gt29v.b[10][1]++;}}catch(e){cov_15fd1gt29v.s[35]++;this.ctx.logger.info('product instance:%j',res);cov_15fd1gt29v.s[36]++;this.ctx.logger.error('error on query product instance details:%j',e);}cov_15fd1gt29v.s[37]++;return await this.inevSonataConverter(res);}}cov_15fd1gt29v.s[38]++;module.exports=ProductInventoryService;