'use strict';var cov_2pt3q7wwb9=function(){var path="/home/pingli/workspace/repository/pccw/demo/sherpa-api/console-core-service-sherpa/app/service/gateway/dashboard.js";var hash="c6017866efd498d836fb75eb6b1664cea65d67f5";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/pingli/workspace/repository/pccw/demo/sherpa-api/console-core-service-sherpa/app/service/gateway/dashboard.js",statementMap:{"0":{start:{line:3,column:15},end:{line:3,column:32}},"1":{start:{line:4,column:21},end:{line:4,column:59}},"2":{start:{line:5,column:20},end:{line:5,column:34}},"3":{start:{line:8,column:18},end:{line:14,column:1}},"4":{start:{line:24,column:23},end:{line:24,column:60}},"5":{start:{line:28,column:4},end:{line:28,column:14}},"6":{start:{line:30,column:4},end:{line:35,column:15}},"7":{start:{line:36,column:4},end:{line:36,column:43}},"8":{start:{line:40,column:27},end:{line:51,column:5}},"9":{start:{line:41,column:25},end:{line:43,column:7}},"10":{start:{line:42,column:8},end:{line:42,column:31}},"11":{start:{line:45,column:6},end:{line:47,column:7}},"12":{start:{line:46,column:8},end:{line:46,column:59}},"13":{start:{line:49,column:6},end:{line:49,column:20}},"14":{start:{line:50,column:6},end:{line:50,column:70}},"15":{start:{line:53,column:4},end:{line:58,column:5}},"16":{start:{line:57,column:6},end:{line:57,column:34}},"17":{start:{line:59,column:4},end:{line:61,column:5}},"18":{start:{line:60,column:6},end:{line:60,column:39}},"19":{start:{line:62,column:4},end:{line:62,column:22}},"20":{start:{line:66,column:4},end:{line:68,column:5}},"21":{start:{line:67,column:6},end:{line:67,column:50}},"22":{start:{line:70,column:4},end:{line:72,column:5}},"23":{start:{line:71,column:6},end:{line:71,column:35}},"24":{start:{line:73,column:4},end:{line:73,column:33}},"25":{start:{line:77,column:17},end:{line:86,column:5}},"26":{start:{line:87,column:4},end:{line:89,column:5}},"27":{start:{line:88,column:6},end:{line:88,column:70}},"28":{start:{line:90,column:4},end:{line:93,column:5}},"29":{start:{line:91,column:6},end:{line:91,column:77}},"30":{start:{line:92,column:6},end:{line:92,column:50}},"31":{start:{line:94,column:4},end:{line:97,column:5}},"32":{start:{line:95,column:6},end:{line:95,column:77}},"33":{start:{line:96,column:6},end:{line:96,column:52}},"34":{start:{line:98,column:4},end:{line:98,column:24}},"35":{start:{line:102,column:17},end:{line:108,column:5}},"36":{start:{line:109,column:4},end:{line:111,column:5}},"37":{start:{line:110,column:6},end:{line:110,column:77}},"38":{start:{line:112,column:4},end:{line:112,column:24}},"39":{start:{line:116,column:17},end:{line:121,column:5}},"40":{start:{line:122,column:4},end:{line:122,column:24}},"41":{start:{line:126,column:17},end:{line:132,column:5}},"42":{start:{line:133,column:4},end:{line:133,column:24}},"43":{start:{line:137,column:4},end:{line:137,column:62}},"44":{start:{line:139,column:23},end:{line:139,column:52}},"45":{start:{line:140,column:22},end:{line:142,column:6}},"46":{start:{line:141,column:6},end:{line:141,column:55}},"47":{start:{line:144,column:4},end:{line:154,column:5}},"48":{start:{line:145,column:22},end:{line:147,column:8}},"49":{start:{line:148,column:6},end:{line:150,column:7}},"50":{start:{line:149,column:8},end:{line:149,column:63}},"51":{start:{line:151,column:6},end:{line:153,column:8}},"52":{start:{line:152,column:8},end:{line:152,column:72}},"53":{start:{line:156,column:19},end:{line:160,column:5}},"54":{start:{line:158,column:8},end:{line:158,column:53}},"55":{start:{line:161,column:4},end:{line:161,column:17}},"56":{start:{line:165,column:4},end:{line:165,column:58}},"57":{start:{line:167,column:23},end:{line:167,column:41}},"58":{start:{line:168,column:24},end:{line:170,column:6}},"59":{start:{line:169,column:6},end:{line:169,column:47}},"60":{start:{line:172,column:19},end:{line:176,column:5}},"61":{start:{line:174,column:8},end:{line:174,column:53}},"62":{start:{line:177,column:4},end:{line:177,column:17}},"63":{start:{line:181,column:4},end:{line:181,column:61}},"64":{start:{line:183,column:22},end:{line:183,column:55}},"65":{start:{line:185,column:4},end:{line:185,column:57}},"66":{start:{line:189,column:4},end:{line:189,column:75}},"67":{start:{line:191,column:24},end:{line:193,column:6}},"68":{start:{line:194,column:4},end:{line:196,column:5}},"69":{start:{line:195,column:6},end:{line:195,column:59}},"70":{start:{line:198,column:17},end:{line:198,column:44}},"71":{start:{line:199,column:4},end:{line:216,column:5}},"72":{start:{line:200,column:18},end:{line:214,column:7}},"73":{start:{line:202,column:28},end:{line:202,column:63}},"74":{start:{line:203,column:25},end:{line:203,column:71}},"75":{start:{line:205,column:10},end:{line:210,column:11}},"76":{start:{line:206,column:12},end:{line:209,column:13}},"77":{start:{line:211,column:10},end:{line:211,column:35}},"78":{start:{line:212,column:10},end:{line:212,column:26}},"79":{start:{line:215,column:6},end:{line:215,column:16}},"80":{start:{line:218,column:4},end:{line:218,column:13}},"81":{start:{line:222,column:0},end:{line:222,column:33}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:27,column:2},end:{line:27,column:3}},loc:{start:{line:27,column:20},end:{line:37,column:3}},line:27},"1":{name:"(anonymous_1)",decl:{start:{line:39,column:2},end:{line:39,column:3}},loc:{start:{line:39,column:22},end:{line:63,column:3}},line:39},"2":{name:"(anonymous_2)",decl:{start:{line:40,column:27},end:{line:40,column:28}},loc:{start:{line:40,column:38},end:{line:51,column:5}},line:40},"3":{name:"(anonymous_3)",decl:{start:{line:41,column:52},end:{line:41,column:53}},loc:{start:{line:42,column:8},end:{line:42,column:31}},line:42},"4":{name:"(anonymous_4)",decl:{start:{line:65,column:2},end:{line:65,column:3}},loc:{start:{line:65,column:29},end:{line:74,column:3}},line:65},"5":{name:"(anonymous_5)",decl:{start:{line:76,column:2},end:{line:76,column:3}},loc:{start:{line:76,column:55},end:{line:99,column:3}},line:76},"6":{name:"(anonymous_6)",decl:{start:{line:101,column:2},end:{line:101,column:3}},loc:{start:{line:101,column:33},end:{line:113,column:3}},line:101},"7":{name:"(anonymous_7)",decl:{start:{line:115,column:2},end:{line:115,column:3}},loc:{start:{line:115,column:32},end:{line:123,column:3}},line:115},"8":{name:"(anonymous_8)",decl:{start:{line:125,column:2},end:{line:125,column:3}},loc:{start:{line:125,column:35},end:{line:134,column:3}},line:125},"9":{name:"(anonymous_9)",decl:{start:{line:136,column:2},end:{line:136,column:3}},loc:{start:{line:136,column:32},end:{line:162,column:3}},line:136},"10":{name:"(anonymous_10)",decl:{start:{line:140,column:37},end:{line:140,column:38}},loc:{start:{line:140,column:47},end:{line:142,column:5}},line:140},"11":{name:"(anonymous_11)",decl:{start:{line:151,column:35},end:{line:151,column:36}},loc:{start:{line:151,column:45},end:{line:153,column:7}},line:151},"12":{name:"(anonymous_12)",decl:{start:{line:157,column:22},end:{line:157,column:23}},loc:{start:{line:157,column:35},end:{line:159,column:7}},line:157},"13":{name:"(anonymous_13)",decl:{start:{line:164,column:2},end:{line:164,column:3}},loc:{start:{line:164,column:28},end:{line:178,column:3}},line:164},"14":{name:"(anonymous_14)",decl:{start:{line:168,column:39},end:{line:168,column:40}},loc:{start:{line:168,column:49},end:{line:170,column:5}},line:168},"15":{name:"(anonymous_15)",decl:{start:{line:173,column:22},end:{line:173,column:23}},loc:{start:{line:173,column:40},end:{line:175,column:7}},line:173},"16":{name:"(anonymous_16)",decl:{start:{line:180,column:2},end:{line:180,column:3}},loc:{start:{line:180,column:31},end:{line:186,column:3}},line:180},"17":{name:"(anonymous_17)",decl:{start:{line:188,column:2},end:{line:188,column:3}},loc:{start:{line:188,column:42},end:{line:219,column:3}},line:188},"18":{name:"(anonymous_18)",decl:{start:{line:201,column:17},end:{line:201,column:18}},loc:{start:{line:201,column:30},end:{line:213,column:9}},line:201}},branchMap:{"0":{loc:{start:{line:45,column:6},end:{line:47,column:7}},type:"if",locations:[{start:{line:45,column:6},end:{line:47,column:7}},{start:{line:45,column:6},end:{line:47,column:7}}],line:45},"1":{loc:{start:{line:45,column:10},end:{line:45,column:55}},type:"binary-expr",locations:[{start:{line:45,column:10},end:{line:45,column:25}},{start:{line:45,column:29},end:{line:45,column:42}},{start:{line:45,column:46},end:{line:45,column:55}}],line:45},"2":{loc:{start:{line:53,column:4},end:{line:58,column:5}},type:"if",locations:[{start:{line:53,column:4},end:{line:58,column:5}},{start:{line:53,column:4},end:{line:58,column:5}}],line:53},"3":{loc:{start:{line:54,column:6},end:{line:55,column:55}},type:"binary-expr",locations:[{start:{line:54,column:6},end:{line:54,column:57}},{start:{line:55,column:6},end:{line:55,column:55}}],line:54},"4":{loc:{start:{line:59,column:4},end:{line:61,column:5}},type:"if",locations:[{start:{line:59,column:4},end:{line:61,column:5}},{start:{line:59,column:4},end:{line:61,column:5}}],line:59},"5":{loc:{start:{line:66,column:4},end:{line:68,column:5}},type:"if",locations:[{start:{line:66,column:4},end:{line:68,column:5}},{start:{line:66,column:4},end:{line:68,column:5}}],line:66},"6":{loc:{start:{line:70,column:4},end:{line:72,column:5}},type:"if",locations:[{start:{line:70,column:4},end:{line:72,column:5}},{start:{line:70,column:4},end:{line:72,column:5}}],line:70},"7":{loc:{start:{line:76,column:41},end:{line:76,column:53}},type:"default-arg",locations:[{start:{line:76,column:49},end:{line:76,column:53}}],line:76},"8":{loc:{start:{line:87,column:4},end:{line:89,column:5}},type:"if",locations:[{start:{line:87,column:4},end:{line:89,column:5}},{start:{line:87,column:4},end:{line:89,column:5}}],line:87},"9":{loc:{start:{line:90,column:4},end:{line:93,column:5}},type:"if",locations:[{start:{line:90,column:4},end:{line:93,column:5}},{start:{line:90,column:4},end:{line:93,column:5}}],line:90},"10":{loc:{start:{line:94,column:4},end:{line:97,column:5}},type:"if",locations:[{start:{line:94,column:4},end:{line:97,column:5}},{start:{line:94,column:4},end:{line:97,column:5}}],line:94},"11":{loc:{start:{line:109,column:4},end:{line:111,column:5}},type:"if",locations:[{start:{line:109,column:4},end:{line:111,column:5}},{start:{line:109,column:4},end:{line:111,column:5}}],line:109},"12":{loc:{start:{line:144,column:4},end:{line:154,column:5}},type:"if",locations:[{start:{line:144,column:4},end:{line:154,column:5}},{start:{line:144,column:4},end:{line:154,column:5}}],line:144},"13":{loc:{start:{line:148,column:6},end:{line:150,column:7}},type:"if",locations:[{start:{line:148,column:6},end:{line:150,column:7}},{start:{line:148,column:6},end:{line:150,column:7}}],line:148},"14":{loc:{start:{line:194,column:4},end:{line:196,column:5}},type:"if",locations:[{start:{line:194,column:4},end:{line:196,column:5}},{start:{line:194,column:4},end:{line:196,column:5}}],line:194},"15":{loc:{start:{line:199,column:4},end:{line:216,column:5}},type:"if",locations:[{start:{line:199,column:4},end:{line:216,column:5}},{start:{line:199,column:4},end:{line:216,column:5}}],line:199},"16":{loc:{start:{line:205,column:10},end:{line:210,column:11}},type:"if",locations:[{start:{line:205,column:10},end:{line:210,column:11}},{start:{line:205,column:10},end:{line:210,column:11}}],line:205}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":0,"61":0,"62":0,"63":0,"64":0,"65":0,"66":0,"67":0,"68":0,"69":0,"70":0,"71":0,"72":0,"73":0,"74":0,"75":0,"76":0,"77":0,"78":0,"79":0,"80":0,"81":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0},b:{"0":[0,0],"1":[0,0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0],"8":[0,0],"9":[0,0],"10":[0,0],"11":[0,0],"12":[0,0],"13":[0,0],"14":[0,0],"15":[0,0],"16":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"c6017866efd498d836fb75eb6b1664cea65d67f5"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const moment=(cov_2pt3q7wwb9.s[0]++,require('moment'));const{InfluxDB}=(cov_2pt3q7wwb9.s[1]++,require('@influxdata/influxdb-client'));const{Service}=(cov_2pt3q7wwb9.s[2]++,require('egg'));// influx range shortcuts, last day/week/month/year
const SHORTCUTS=(cov_2pt3q7wwb9.s[3]++,{D:'|> range(start:-1d)',W:'|> range(start:-1w)',M:'|> range(start:-1mo)',Y:'|> range(start:-1y)',ALL:'|> range(start: 0)'});// 1ms - 1 millisecond
// 1s  - 1 second
// 1m  - 1 minute
// 1h  - 1 hour
// 1d  - 1 day
// 1w  - 1 week
// 1mo - 1 calendar month
// 1y  - 1 calendar year
const INTERVAL_REGEX=(cov_2pt3q7wwb9.s[4]++,new RegExp(/^\d+(y|mo|w|d|h|m|s|ms)/));class DashboardService extends Service{constructor(app){cov_2pt3q7wwb9.f[0]++;cov_2pt3q7wwb9.s[5]++;super(app);cov_2pt3q7wwb9.s[6]++;this.influxClient=new InfluxDB({url:this.config.influx.url,token:this.config.influx.token}).getQueryApi(this.config.influx.org).with({});cov_2pt3q7wwb9.s[7]++;this.bucket=this.config.influx.bucket;}filterRange(query){cov_2pt3q7wwb9.f[1]++;cov_2pt3q7wwb9.s[8]++;const validateFromTo=query=>{cov_2pt3q7wwb9.f[2]++;const[from,to]=(cov_2pt3q7wwb9.s[9]++,[query.from,query.to].map(i=>{cov_2pt3q7wwb9.f[3]++;cov_2pt3q7wwb9.s[10]++;return moment(i,'YYYY-MM-DD');}));cov_2pt3q7wwb9.s[11]++;if((cov_2pt3q7wwb9.b[1][0]++,!from.isValid())||(cov_2pt3q7wwb9.b[1][1]++,!to.isValid())||(cov_2pt3q7wwb9.b[1][2]++,from>to)){cov_2pt3q7wwb9.b[0][0]++;cov_2pt3q7wwb9.s[12]++;return this.ctx.throw(400,'invalidate query date');}else{cov_2pt3q7wwb9.b[0][1]++;}// add 1 day so it will inlucde 'to' date
cov_2pt3q7wwb9.s[13]++;to.add(1,'d');cov_2pt3q7wwb9.s[14]++;return`|> range(start: ${from.format()}, stop: ${to.format()})`;};// custom date range overrides shortcuts
cov_2pt3q7wwb9.s[15]++;if((cov_2pt3q7wwb9.b[3][0]++,Object.prototype.hasOwnProperty.call(query,'from'))&&(cov_2pt3q7wwb9.b[3][1]++,Object.prototype.hasOwnProperty.call(query,'to'))){cov_2pt3q7wwb9.b[2][0]++;cov_2pt3q7wwb9.s[16]++;return validateFromTo(query);}else{cov_2pt3q7wwb9.b[2][1]++;}cov_2pt3q7wwb9.s[17]++;if(Object.keys(SHORTCUTS).includes(query.shortcuts)){cov_2pt3q7wwb9.b[4][0]++;cov_2pt3q7wwb9.s[18]++;return SHORTCUTS[query.shortcuts];}else{cov_2pt3q7wwb9.b[4][1]++;}cov_2pt3q7wwb9.s[19]++;return SHORTCUTS.W;}filterTimeInterval(query){cov_2pt3q7wwb9.f[4]++;cov_2pt3q7wwb9.s[20]++;if(INTERVAL_REGEX.test(query.interval)){cov_2pt3q7wwb9.b[5][0]++;cov_2pt3q7wwb9.s[21]++;return`|> window(every: ${query.interval})`;}else{cov_2pt3q7wwb9.b[5][1]++;}// PLATPO-1307 shortcuts are longer then 1 month, window to 1 day
cov_2pt3q7wwb9.s[22]++;if(['M','Y','ALL'].includes(query.shortcuts)){cov_2pt3q7wwb9.b[6][0]++;cov_2pt3q7wwb9.s[23]++;return'|> window(every: 1d)';}else{cov_2pt3q7wwb9.b[6][1]++;}cov_2pt3q7wwb9.s[24]++;return'|> window(every: 1h)';}genServiceUsageCountFlux(query,type,apiId=(cov_2pt3q7wwb9.b[7][0]++,null)){cov_2pt3q7wwb9.f[5]++;const flux=(cov_2pt3q7wwb9.s[25]++,[`from(bucket: "${this.bucket}")`,this.filterRange(query),'',// filter for apiID
'',// filter for for error/success
'|> group()|> sort()',this.filterTimeInterval(query),'|> group(columns: ["_start"])|> count()','|> yield(name: "Hits")']);cov_2pt3q7wwb9.s[26]++;if(apiId!==null){cov_2pt3q7wwb9.b[8][0]++;cov_2pt3q7wwb9.s[27]++;flux.splice(2,1,`|> filter(fn: (r) => r.APIID == "${apiId}")`);}else{cov_2pt3q7wwb9.b[8][1]++;}cov_2pt3q7wwb9.s[28]++;if(type==='error'){cov_2pt3q7wwb9.b[9][0]++;cov_2pt3q7wwb9.s[29]++;flux.splice(3,1,'|> filter(fn: (r) => r.ResponseCode =~ /[45].{2}/)');cov_2pt3q7wwb9.s[30]++;flux.splice(7,1,'|> yield(name: "Error")');}else{cov_2pt3q7wwb9.b[9][1]++;}cov_2pt3q7wwb9.s[31]++;if(type==='success'){cov_2pt3q7wwb9.b[10][0]++;cov_2pt3q7wwb9.s[32]++;flux.splice(3,1,'|> filter(fn: (r) => r.ResponseCode =~ /[23].{2}/)');cov_2pt3q7wwb9.s[33]++;flux.splice(7,1,'|> yield(name: "Success")');}else{cov_2pt3q7wwb9.b[10][1]++;}cov_2pt3q7wwb9.s[34]++;return flux.join('');}genTop3CountFlux(query,type){cov_2pt3q7wwb9.f[6]++;const flux=(cov_2pt3q7wwb9.s[35]++,[`from(bucket: "${this.bucket}")`,this.filterRange(query),'',// filter for error
'|> group(columns:[ "APIName", "APIID"])|> count() |> group()','|> sort(columns: ["APIName" ], desc: true)']);cov_2pt3q7wwb9.s[36]++;if(type==='error'){cov_2pt3q7wwb9.b[11][0]++;cov_2pt3q7wwb9.s[37]++;flux.splice(2,1,'|> filter(fn: (r) => r.ResponseCode =~ /[45].{2}/)');}else{cov_2pt3q7wwb9.b[11][1]++;}cov_2pt3q7wwb9.s[38]++;return flux.join('');}genBreakdownCountFlux(query){cov_2pt3q7wwb9.f[7]++;const flux=(cov_2pt3q7wwb9.s[39]++,[`from(bucket: "${this.bucket}")`,this.filterRange(query),'|> group(columns: ["ResponseCode"])|> count()','|> yield(name: "count")']);cov_2pt3q7wwb9.s[40]++;return flux.join('');}genKeyCountFlux(query,keyHash){cov_2pt3q7wwb9.f[8]++;const flux=(cov_2pt3q7wwb9.s[41]++,[`from(bucket: "${this.bucket}")`,this.filterRange(query),`|> filter(fn: (r) => r.APIKey == "${keyHash}")`,'|> group()|> count()','|> yield(name: "count")']);cov_2pt3q7wwb9.s[42]++;return flux.join('');}async usageOfServices(query){cov_2pt3q7wwb9.f[9]++;cov_2pt3q7wwb9.s[43]++;this.ctx.logger.info('usageOfServices payload: %j',query);const filterKeys=(cov_2pt3q7wwb9.s[44]++,['total','error','success']);let fluxQueries=(cov_2pt3q7wwb9.s[45]++,filterKeys.map(type=>{cov_2pt3q7wwb9.f[10]++;cov_2pt3q7wwb9.s[46]++;return this.genServiceUsageCountFlux(query,type);}));cov_2pt3q7wwb9.s[47]++;if(new RegExp(/^\d+$/).test(query.id)){cov_2pt3q7wwb9.b[12][0]++;const service=(cov_2pt3q7wwb9.s[48]++,await this.ctx.model.Service.findOne({where:{id:query.id}}));cov_2pt3q7wwb9.s[49]++;if(!service){cov_2pt3q7wwb9.b[13][0]++;cov_2pt3q7wwb9.s[50]++;this.ctx.throw(400,`service not found by ${query.id}`);}else{cov_2pt3q7wwb9.b[13][1]++;}cov_2pt3q7wwb9.s[51]++;fluxQueries=filterKeys.map(type=>{cov_2pt3q7wwb9.f[11]++;cov_2pt3q7wwb9.s[52]++;return this.genServiceUsageCountFlux(query,type,service.apiId);});}else{cov_2pt3q7wwb9.b[12][1]++;}const result=(cov_2pt3q7wwb9.s[53]++,await Promise.all(fluxQueries.map(async q=>{cov_2pt3q7wwb9.f[12]++;cov_2pt3q7wwb9.s[54]++;return await this.influxClient.collectRows(q);})));cov_2pt3q7wwb9.s[55]++;return result;}async usageOfTops(query){cov_2pt3q7wwb9.f[13]++;cov_2pt3q7wwb9.s[56]++;this.ctx.logger.info('usageOfTops payload: %j',query);const filterKeys=(cov_2pt3q7wwb9.s[57]++,['total','error']);const fluxQueries=(cov_2pt3q7wwb9.s[58]++,filterKeys.map(type=>{cov_2pt3q7wwb9.f[14]++;cov_2pt3q7wwb9.s[59]++;return this.genTop3CountFlux(query,type);}));const result=(cov_2pt3q7wwb9.s[60]++,await Promise.all(fluxQueries.map(async(q,idx)=>{cov_2pt3q7wwb9.f[15]++;cov_2pt3q7wwb9.s[61]++;return await this.influxClient.collectRows(q);})));cov_2pt3q7wwb9.s[62]++;return result;}async usageBreakdown(query){cov_2pt3q7wwb9.f[16]++;cov_2pt3q7wwb9.s[63]++;this.ctx.logger.info('usageBreakdown payload: %j',query);const fluxQuery=(cov_2pt3q7wwb9.s[64]++,this.genBreakdownCountFlux(query));cov_2pt3q7wwb9.s[65]++;return await this.influxClient.collectRows(fluxQuery);}async usageOfOneApplication(id,query){cov_2pt3q7wwb9.f[17]++;cov_2pt3q7wwb9.s[66]++;this.ctx.logger.info(`usageOfOneApplication: ${id} payload: %j`,query);const application=(cov_2pt3q7wwb9.s[67]++,await this.ctx.model.Application.findOne({where:{id}}));cov_2pt3q7wwb9.s[68]++;if(!application){cov_2pt3q7wwb9.b[14][0]++;cov_2pt3q7wwb9.s[69]++;this.ctx.throw(400,`application not found by ${id}`);}else{cov_2pt3q7wwb9.b[14][1]++;}const keys=(cov_2pt3q7wwb9.s[70]++,await application.getKeys());cov_2pt3q7wwb9.s[71]++;if(keys.length>0){cov_2pt3q7wwb9.b[15][0]++;const res=(cov_2pt3q7wwb9.s[72]++,await Promise.all(keys.map(async k=>{cov_2pt3q7wwb9.f[18]++;const fluxQuery=(cov_2pt3q7wwb9.s[73]++,this.genKeyCountFlux(query,k.hash));const keyRes=(cov_2pt3q7wwb9.s[74]++,await this.influxClient.collectRows(fluxQuery));// key is not used, so influx returns an empty list
cov_2pt3q7wwb9.s[75]++;if(keyRes.length===0){cov_2pt3q7wwb9.b[16][0]++;cov_2pt3q7wwb9.s[76]++;return{value:k.value,_value:'0'};}else{cov_2pt3q7wwb9.b[16][1]++;}cov_2pt3q7wwb9.s[77]++;keyRes[0].value=k.value;cov_2pt3q7wwb9.s[78]++;return keyRes[0];})));cov_2pt3q7wwb9.s[79]++;return res;}else{cov_2pt3q7wwb9.b[15][1]++;}// no keys on this application
cov_2pt3q7wwb9.s[80]++;return[];}}cov_2pt3q7wwb9.s[81]++;module.exports=DashboardService;